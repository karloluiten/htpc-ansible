---
- name: Create plex group
  group:
    name: "{{ plex.group }}"
    system: yes

- name: Create plex user
  user:
    name: "{{ plex.user }}"
    home: "/home/plex"
    group: "{{ plex.group }}"
    system: yes

- name: Add plexmediaserver ppa
  apt_repository:
    repo: "deb https://downloads.plex.tv/repo/deb/ public main"
    state: present
    filename: plexmediaserver


- name: Add plexmediaserver ppa key
  apt_key:
    url: "https://downloads.plex.tv/plex-keys/PlexSign.key"
    state: present

- name: Install plexmediaserver
  apt:
    name: plexmediaserver
    update_cache: yes
    state: present

- name: Copy default config to /etc/default/plexmediaserver
  template:
    src: plex_default.j2
    dest: "/etc/default/plexmediaserver"
    owner: root
    group: root
    mode: 0644
  become: yes
  become_method: sudo
  tags: configplex
  notify: restart plex

- name: Create plex systemctl service
  template:
    src: plex_service.j2
    dest: /etc/systemd/system/plexmediaserver.service
    owner: root
    group: root
    mode: 664

- name: Enable plexmediaserver service at startup
  systemd:
    name: plexmediaserver
    enabled: yes
    daemon_reload: yes

- name: Ufw open tcp ports
  ufw: rule=allow port={{ item }} proto=tcp
  with_items:
    - 32400
    - 32469
    - 61636

- name: Ufw open udp ports
  ufw: rule=allow port={{ item }} proto=udp
  with_items:
    - 32413
    - 1900
    - 32412
    - 32410
    - 32414
    - 65535

- include: acd.yml
  when: use_acd
  tags: plex_acd

# - include: plexwatch.yml
#   when: install_plexwatch
#   tags: plexwatch
